# IEC 60870-5-101 Драйвер протоколу сервера

Цей драйвер реалізує сервер для протоколу IEC 101. Цей драйвер може використовувати послідовний порт RS-232C або TCP-з'єднання (віртуальний послідовний порт). Він може розподіляти дані за кількома з'єднаннями на декількох комп'ютерах, якщо це необхідно. Він може мати лише одного клієнта, підключеного до кожного послідовного порту TCPor.
Драйвер прослуховує відповідні зміни даних у потоці змін бази даних MongoDB, надсилаючи зміни даних вгору за винятком. Загальні допити та групові допити підтримуються для опитування доброчесності клієнтами.

Для конфігурації драйвера необхідно створити один або кілька екземплярів драйвера і принаймні для підключення на кожен екземпляр. Також теги, призначені для надсилання на з'єднання, повинні бути налаштовані належним чином.

## Налаштуйте екземпляр драйвера

Щоб створити новий екземпляр сервера IEC 101, вставте новий документ у колекцію _protocolDriverInsests_, використовуючи таку команду:

    use json_scada_db_name
    db.protocolDriverInstances.insert({
            protocolDriver: "IEC60870-5-101_SERVER",
            protocolDriverInstanceNumber: 1,
            enabled: true,
            logLevel: 1,
            nodeNames: ["mainNode"], 
            activeNodeName: "mainNode",
            activeNodeKeepAliveTimeTag: new Date(),
            keepProtocolRunningWhileInactive: true
        });

* _**protocolDriver**_ [String] - ім'я драйвера протоколу, має бути "IEC60870-5-101_SERVER". **Обов’язковий параметр**.
* _**protocolDriverInstanceNumber**_ [Double] - номер екземпляра. Використовуйте від 1 до N, щоб пронумерувати екземпляри. Для одного і того ж драйвера номери екземплярів повинні бути унікальними. Номер екземпляра дозволяє запустити використання кількох процесів драйвера, кожен з різною конфігурацією. **Обов’язковий параметр**.
* _**увімкнено**_ [Boolean] - керує ввімкненням екземпляра. Використовуйте тут false, щоб вимкнути екземпляр. **Обов’язковий параметр**.
* _**logLevel**_ [Double] - код номера для рівня журналу (0=мінімальний, 1=основний, 2=детальний, 3=налагоджений). Занадто багато реєстрації (рівні 2 та 3) може вплинути на продуктивність. **Обов’язковий параметр**.
* _**nodeNames**_ [Array of Strings] - масив імен вузлів, які можуть запускати екземпляр. Використовуйте більше одного вузла для надмірності. Кожен надлишковий екземпляр, що працює на окремих вузлах, матиме однакові підключення та дані, увімкнені для розповсюдження. **Обов’язковий параметр**.
* _**activeNodeName**_ [String] - Ім'я вузла драйвера протоколу, який є активним на даний момент. Це оновлено драйверами для контролю надмірності. Це насправді не використовується цим драйвером, оскільки всі екземпляри завжди активні. **Необов’язково**.
* _**activeNodeKeepAliveTimeTag**_ [Дата] - це регулярно оновлюється активним драйвером. Це насправді не використовується цим драйвером, оскільки всі екземпляри завжди активні. **Необов’язково**.
* _**keepProtocolRunningWhileInactive**_ [Boolean] - визначає, що драйвер підтримуватиме протокол, а не основний активний драйвер. Це насправді не використовується цим драйвером, оскільки всі екземпляри завжди активні. **Необов’язково**.

Зміни в конфігурації _protocolDriverInsests_ вимагають перезапуску процесів екземплярів драйвера, щоб бути ефективними.

## Налаштуйте сервери

Екземпляр цього драйвера може мати багато визначених портів сервера, які повинні бути описані в колекції _protocolConnections_.

    use json_scada_db_name
    db.protocolConnections.insert({
            protocolDriver: "IEC60870-5-101_SERVER",
            protocolDriverInstanceNumber: 1,
            protocolConnectionNumber: 1002,
            name: "IEC101DIST",
            description: "Distribution of IEC 101",
            enabled: true,
            commandsEnabled: true,
            portName: "COM3", 
            baudRate: 9600,
            parity: "Even",
            stopBits: "One",
            handshake: "None",
            timeoutForACK: 1000,
            timeoutRepeat: 1000,
            useSingleCharACK: true,
            sizeOfLinkAddress: 1,
            localLinkAddress: 1,
            remoteLinkAddress: 0,
            giInterval: null,
            testCommandInterval: 0,
            timeSyncInterval: 0,
            sizeOfCOT: 2,
            sizeOfCA: 2,
            sizeOfIOA: 3,
            maxQueueSize: 50
        });

* _**protocolDriver**_ [String] - ім'я драйвера протоколу, має бути "IEC60870-5-101_SERVER". **Обов’язковий параметр**.
* _**protocolDriverInstanceNumber**_ [Double] - номер екземпляра. Використовуйте від 1 до N, щоб пронумерувати екземпляри. Для одного і того ж драйвера номери екземплярів повинні бути унікальними. Номер екземпляра дозволяє запустити використання кількох процесів драйвера, кожен з різною конфігурацією. **Обов’язковий параметр**.
* _**protocolConnectionNumber**_ [Double] - Номерний номер для підключення протоколу. Це повинно бути унікальним для всіх підключень усіх драйверів системи. Цей номер буде використаний для спрямування тегів на з'єднання із сервером розподілу. **Обов’язковий параметр**.
* _**ім'я**_ [String] - Ім'я для з'єднання. Використовуватиметься для лісозаготівлі. **Обов’язковий параметр**.
* _**опис**_ [String] - Опис з метою підключення. Просто документально. **Необов’язковий параметр**.
* _**увімкнено**_ [Boolean] - керує ввімкненням з'єднання. Використовуйте тут false, щоб вимкнути з’єднання. **Обов’язковий параметр**.
* _**commandEnabled**_ [Boolean] - Дозволяє вимкнути команди (повідомлення в напрямку управління) для з'єднання. Використовуйте тут false, щоб вимкнути команди. **Обов’язковий параметр**.
* _**portName**_ [String] - назва порту Comm, наприклад "COM1", "/ dev / ttyS0", "192.168.0.1:2410" для TCP-адреси: порт. **Обов’язковий параметр**.
* _**baudRate**_ [Double] - швидкість передачі даних в порт кому. **Обов’язковий параметр**.
* _**парність**_ [String] - парність портів зв'язку Четне | Немає | Непарне | Позначити | Пробіл. **Обов’язковий параметр**.
* _**стоп-біти**_ [String] - номер порту зв'язку стоп-бітів Один | Один5 | Два. **Обов’язковий параметр**.
* _**рукостискання**_ [String] - параметр рукостискання порту зв'язку Немає | Xon | Rts | RtsXon. **Обов’язковий параметр**.
* _**timeoutForACK**_ [Double] - час очікування порту зв'язку для ACK повідомлення рівня посилання (мс). **Обов’язковий параметр**.
* _**timeoutRepeat**_ [Double] - Час очікування порту зв'язку для повторної передачі повідомлень рівня шару (мс). **Обов’язковий параметр**.
* _**useSingleCharACK**_ [Boolean] - вказує, чи буде рівень вторинного каналу використовувати одинарний символ ACK (E5). **Обов’язковий параметр**.
* _**sizeOfLinkAddress**_ [Double] - Розмір поля адреси рівня посилання LPCI. Може бути 0, 1 або 2. **Обов’язковий параметр**.
* _**localLinkAddress**_ [Double] - Місцева адреса посилання для з'єднання (адреса ініціатора). **Обов’язковий параметр**.
* _**remoteLinkAddress**_ [Double] - Не використовується для цього драйвера. **Необов’язковий параметр**.
* _**giInterval**_ [Double] - Не використовується для цього драйвера. **Необов’язковий параметр**.
* _**testCommandInterval**_ [Double] - Не використовується для цього драйвера. **Необов’язковий параметр**.
* _**timeSyncInterval**_ [Double] - Не використовується для цього драйвера. **Обов’язковий параметр**.
* _**sizeOfCOT**_ [Double] - Розмір поля протоколу причини передачі в байтах (1 або 2). **Обов’язковий параметр**.
* _**sizeOfCA**_ [Double] - Розмір поля протоколу командної адреси в байтах (1 або 2). **Обов’язковий параметр**.
* _**sizeOfIOA**_ [Double] - Розмір поля протоколу адреси інформаційного об'єкта в байтах (1, 2 або 3). **Обов’язковий параметр**.
* _**maxQueueSize**_ [Double] - Максимальна кількість повідомлень (Class1 або Class 2), які можна буферизувати. **Обов’язковий параметр**.

## Налаштуйте теги для розповсюдження

Кожен тег, що розповсюджується по з'єднанню, повинен мати встановлений пункт призначення протоколу. Тег може також розповсюджуватися по кількох з'єднаннях.
Масив цільових протоколів надходить у поле _protocolDestinations_ тегу колекції _realtimeData_.

Параметри призначення протоколу для тегу визначають, як інформація буде передаватися протоколом.

Виберіть тег для розподільного з'єднання, як показано нижче.

    use json_scada_db_name
    db.realtimeData.updateOne({"tag":"A_TAG_NAME"}, {
        $set: {
            "protocolDestinations":[{
                "protocolDestinationConnectionNumber": 1002,
                "protocolDestinationCommonAddress": 1,
                "protocolDestinationObjectAddress": 12345,
                "protocolDestinationASDU": 13,
                "protocolDestinationCommandDuration": 0,
                "protocolDestinationCommandUseSBO": false,
                "protocolDestinationKConv1": 1,
                "protocolDestinationKConv2": 0,
                "protocolDestinationGroup": 0,
                "protocolDestinationHoursShift": -2
                }]
            }
        });

Ця остання команда видалить усі попередні цільові призначення для тегу.

Скористайтеся командою, наведеною нижче, щоб додати пункт призначення, не видаляючи інших.
 
     db.realtimeData.updateOne({"tag":"A_TAG_NAME"}, {
        $push: {
            "protocolDestinations": {
                "protocolDestinationConnectionNumber": 1002,
                "protocolDestinationCommonAddress": 1,
                "protocolDestinationObjectAddress": 12345,
                "protocolDestinationASDU": 13,
                "protocolDestinationCommandDuration": 0,
                "protocolDestinationCommandUseSBO": false,
                "protocolDestinationKConv1": 1,
                "protocolDestinationKConv2": 0,
                "protocolDestinationGroup": 0,
                "protocolDestinationHoursShift": -2
                }
            }
    });



Опис параметрів для _protocolDestinations_
* _**protocolDestinationConnectionNumber**_ - Номерний номер з'єднання протоколу (повинен збігатися з номером коду бажаного з'єднання розподілу, визначеного в колекції _protocolConnections_). **Обов’язковий параметр**.
* _**protocolDestinationCommonAddress**_ - загальна адреса (CA), що використовується для протоколу IEC 101. **Обов’язковий параметр**.
* _**protocolDestinationObjectAddress**_ - Адреса інформаційного об'єкта (IOA) для розподіленого значення в протоколі (комбінація CA / IOA не повинна повторюватися для різних об'єктів на одному з'єднанні). **Обов’язковий параметр**.
* _**protocolDestinationASDU**_ - код номера типу ASDU для передачі даних. Наприклад, 13 для плаваючої, 1 для цифрової одинарної, 45 для цифрової команди. **Обов’язковий параметр**.
* _**protocolDestinationCommandDuration**_ - Параметри команд, поле IEC-104 QU: 0=Не вказано, 1=Короткий імпульс, 2=Тривалий імпульс, 3=Постійний. Просто значущий для команд. **Обов’язковий параметр**.
* _**protocolDestinationCommandUseSBO**_ - Використовувати чи ні Вибрати перед операцією для команди. Використовуйте _false_ для прямого виконання. Значимо лише для команд. **Обов’язковий параметр**.
* _**protocolDestinationKConv1**_ - коефіцієнт перетворення значень (множник). Використовуйте -1 для інвертування цифрових станів. **Обов’язковий параметр**.
* _**protocolDestinationKConv2**_ - коефіцієнт перетворення значень (суматор). **Обов’язковий параметр**.
* _**protocolDestinationGroup**_ - Група розподілу (0-16). Нуль відповість лише на загальний допит станції (INROGEN). 1-16 відповість на конкретний груповий допит та INROGEN. Використовуйте -1, щоб уникнути включення до будь-якої відповіді групового допиту. **Обов’язковий параметр**.
* _**protocolDestinationHoursShift**_ - Кількість годин на зміщення польових штампів часу. Використовуйте додатні значення для додавання годин, а негативні - для віднімання. Нуль збереже часові позначки в цілості. **Обов’язковий параметр**.

Коли для тегу змінено призначення протоколу, ця зміна негайно набере чинності для запущених драйверів. Не потрібно перезапускати будь-який процес.