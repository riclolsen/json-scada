# IEC 60870-5-104 Драйвер протоколу сервера

Цей драйвер реалізує сервер для протоколу IEC 104. Він може розподіляти дані за кількома з'єднаннями на декількох комп'ютерах, якщо це необхідно. Він може мати декількох клієнтів, підключених на кожному порту, що відкривається TCP-сервером.
Драйвер прослуховує відповідні зміни даних у потоці змін бази даних MongoDB, надсилаючи зміни даних вгору за винятком. Загальні допити та групові допити підтримуються для опитування доброчесності клієнтами.

Для конфігурації драйвера необхідно створити один або кілька екземплярів драйвера і принаймні для підключення на кожен екземпляр. Також теги, призначені для надсилання на з'єднання, повинні бути налаштовані належним чином.

## Налаштуйте екземпляр драйвера

Щоб створити новий екземпляр сервера IEC 104, вставте новий документ у колекцію _protocolDriverInsests_, використовуючи таку команду:

    use json_scada_db_name
    db.protocolDriverInstances.insert({
            protocolDriver: "IEC60870-5-104_SERVER",
            protocolDriverInstanceNumber: 1,
            enabled: true,
            logLevel: 1,
            nodeNames: ["mainNode"], 
            activeNodeName: "mainNode",
            activeNodeKeepAliveTimeTag: new Date(),
            keepProtocolRunningWhileInactive: true
        });

* _**protocolDriver**_ [String] - ім'я драйвера протоколу, має бути "IEC60870-5-104_SERVER". **Обов’язковий параметр**.
* _**protocolDriverInstanceNumber**_ [Double] - номер екземпляра. Використовуйте від 1 до N, щоб пронумерувати екземпляри. Для одного і того ж драйвера номери екземплярів повинні бути унікальними. Номер екземпляра дозволяє запустити використання кількох процесів драйвера, кожен з різною конфігурацією. **Обов’язковий параметр**.
* _**увімкнено**_ [Boolen] - керує ввімкненням екземпляра. Використовуйте тут false, щоб вимкнути екземпляр. **Обов’язковий параметр**.
* _**logLevel**_ [Double] - код номера для рівня журналу (0 = мінімальний, 1 = основний, 2 = детальний, 3 = налагоджений). Занадто багато реєстрації (рівні 2 та 3) може вплинути на продуктивність. **Обов’язковий параметр**.
* _**nodeNames**_ [Array of Strings] - масив імен вузлів, які можуть запускати екземпляр. Використовуйте більше одного вузла для надмірності. Кожен надлишковий екземпляр, що працює на окремих вузлах, матиме однакові підключення та дані, увімкнені для розповсюдження. **Обов’язковий параметр**.
* _**activeNodeName**_ [String] - Ім'я вузла драйвера протоколу, який є активним на даний момент. Це оновлено драйверами для контролю надмірності. Це насправді не використовується цим драйвером, оскільки всі екземпляри завжди активні. **Необов’язково**.
* _**activeNodeKeepAliveTimeTag**_ [Date] - це регулярно оновлюється активним драйвером. Це насправді не використовується цим драйвером, оскільки всі екземпляри завжди активні. **Необов’язково**.
* _**keepProtocolRunningWhileInactive**_ [Boolean] - визначає, що драйвер підтримуватиме протокол, а не основний активний драйвер. Це насправді не використовується цим драйвером, оскільки всі екземпляри завжди активні. **Необов’язково**.

Зміни в конфігурації _protocolDriverInsests_ вимагають перезапуску процесів екземплярів драйвера, щоб бути ефективними.

## Налаштуйте сервери

Екземпляр цього драйвера може мати багато визначених портів сервера, які повинні бути описані в колекції _protocolConnections_.

    use json_scada_db_name
    db.protocolConnections.insert({
            protocolDriver: "IEC60870-5-104_SERVER",
            protocolDriverInstanceNumber: 1,
            protocolConnectionNumber: 1001,
            name: "IEC104DIST",
            description: "Distribution of IEC 104",
            enabled: true,
            commandsEnabled: true,
            ipAddressLocalBind: "0.0.0.0:2404", 
            ipAddresses: [],
            localLinkAddress: 1,
            remoteLinkAddress: 0,
            giInterval: null,
            testCommandInterval: 0,
            timeSyncInterval: 0,
            sizeOfCOT: 2,
            sizeOfCA: 2,
            sizeOfIOA: 3,
            k: 12,
            w: 8,
            t0: 10,
            t1: 15,
            t2: 10,
            t3: 20,
            serverModeMultiActive: true,
            maxClientConnections: 20,
            maxQueueSize: 500
        });

        * _**protocolDriver**_ [String] - ім'я драйвера протоколу, має бути "IEC60870-5-104_SERVER". **Обов’язковий параметр**.
* _**protocolDriverInstanceNumber**_ [Double] - номер екземпляра. Використовуйте від 1 до N, щоб пронумерувати екземпляри. Для одного і того ж драйвера номери екземплярів повинні бути унікальними. Номер екземпляра дозволяє запустити використання кількох процесів драйвера, кожен з різною конфігурацією. **Обов’язковий параметр**.
* _**protocolConnectionNumber**_ [Double] - Номерний номер для підключення протоколу. Це повинно бути унікальним для всіх підключень усіх драйверів системи. Цей номер буде використаний для спрямування тегів на з'єднання із сервером розподілу. **Обов’язковий параметр**.
* _**ім'я**_ [String] - Ім'я для з'єднання. Використовуватиметься для лісозаготівлі. **Обов’язковий параметр**.
* _**опис**_ [String] - Опис з метою підключення. Просто документально. **Необов’язковий параметр**.
* _**увімкнено**_ [Boolen] - керує ввімкненням сполучення. Використовуйте тут false, щоб вимкнути з’єднання. **Обов’язковий параметр**.
* _**commandEnabled**_ [Boolean] - Дозволяє вимкнути команди (повідомлення в напрямку управління) для з'єднання. Використовуйте тут false, щоб вимкнути команди. **Обов’язковий параметр**.
* _**ipAddressLocalBind**_ [String] - прив'язка IP-адреси та порту сервера. Використовуйте 127.0.0.1:2404 лише для локальних з'єднань на порту 2404. Використовуйте 0.0.0.0:2404, щоб слухати на всіх інтерфейсах. Порт не повинен повторюватися для інших підключень на тому ж комп'ютері (оскільки для кожного порту TCP на одному комп'ютері можна відкрити лише один сокет прослуховування). **Обов’язковий параметр**.
* _**ipAddresses**_ [Array String] - масив IP-адрес для клієнтів, яким дозволено підключатися до сервера. Зберігайте порожній масив, щоб прийняти будь-якого клієнта. **Обов’язковий параметр**.
* _**localLinkAddress**_ [Double] - Місцева адреса посилання для з'єднання (адреса ініціатора). **Обов’язковий параметр**.
* _**remoteLinkAddress**_ [Double] - Не використовується для цього драйвера. **Необов’язковий параметр**.
* _**giInterval**_ [Double] - Не використовується для цього драйвера. **Необов’язковий параметр**.
* _**testCommandInterval**_ [Double] - Не використовується для цього драйвера. **Необов’язковий параметр**.
* _**timeSyncInterval**_ [Double] - Не використовується для цього драйвера. **Обов’язковий параметр**.
* _**sizeOfCOT**_ [Double] - Розмір поля протоколу причини передачі в байтах (1 або 2). **Обов’язковий параметр**.
* _**sizeOfCA**_ [Double] - Розмір поля протоколу командної адреси в байтах (1 або 2). **Обов’язковий параметр**.
* _**sizeOfIOA**_ [Double] - Розмір поля протоколу адреси інформаційного об'єкта в байтах (1, 2 або 3). **Обов’язковий параметр**.
* _**k**_ [Double] - параметр протоколу _k_. **Обов’язковий параметр**.
* _**w**_ [Double] - параметр протоколу _w_. **Обов’язковий параметр**.
* _**t0**_ [Double] - час очікування протоколу _t0_ у секундах. **Обов’язковий параметр**.
* _**t1**_ [Double] - час очікування протоколу _t1_ у секундах. **Обов’язковий параметр**.
* _**t2**_ [Double] - час очікування протоколу _t2_ у секундах. **Обов’язковий параметр**.
* _**t3**_ [Double] - час очікування протоколу _t3_ у секундах. **Обов’язковий параметр**.
* _**serverModeMultiActive**_ [Boolen] - якщо значення true, для кожного клієнта зберігається окремий буфер даних. **Обов’язковий параметр**.
* _**maxClientConnections**_ [Double] - Максимальна кількість клієнтів, яким дозволено підключатися одночасно. **Обов’язковий параметр**.
* _**maxQueueSize**_ [Double] - Максимальна кількість повідомлень, які можна буферизувати. **Обов’язковий параметр**.

## Налаштуйте теги для розповсюдження

Кожен тег, що розповсюджується по з'єднанню, повинен мати встановлений пункт призначення протоколу. Тег може також розповсюджуватися по кількох з'єднаннях.
Масив цільових протоколів надходить у поле _protocolDestinations_ тегу колекції _realtimeData_.

Параметри призначення протоколу для тегу визначають, як інформація буде передаватися протоколом.
