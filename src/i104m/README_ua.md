# Клієнт I104M

Цей протокол є спеціальним протоколом, який використовується драйверами у проекті OSHMI.
Це дозволяє використовувати драйвери OSHMI в JSON-SCADA.
Драйвер ICCP, який є частиною вихідного коду JSON-SCADA, використовує протокол I104M.

Повідомлення передаються через UDP із користувацьким форматом на основі ASDU IEC60870-5-104.

Реалізація розроблена з використанням мови Go.

В основному це процес, який прослуховує повідомлення UDP і записує вхідні дані в MongoDB. Крім того, потік змін MongoDB використовується для моніторингу команд (збір CommandsQueue) і пересилання до пункту призначення UDP.

## Конфігурація

Екземпляр драйвера повинен бути створений у колекції "protocolDriverInsests":

    db.protocolDriverInsests.insert ({
        "protocolDriver": "I104M",                     // ім'я драйвера має бути "I104M"
        "protocolDriverInstanceNumber": 1,             // номер екземпляра, за потреби використовуйте 1 або більше
        "enabled": true,                               // увімкнути екземпляр
        "logLevel": 1,                                 // регулюємо рівень журналу 0-N
        "nodeNames": ["mainNode", "secondaryNode"],    // список імен вузлів, які будуть запускати екземпляр
        "keepProtocolRunningWhileInactive": false,     // тут завжди використовуємо false
        "activeNodeKeepAliveTimeTag": datetime.now (), // це буде оновлено екземпляром активного диска
        "activeNodeName": ""                           // це буде оновлено екземпляром активного диска
        })

Цей драйвер протоколу може запускати кілька вузлів. Список "nodeNames", який буде запускати екземпляр драйвера. Одночасно для екземпляра може бути активним лише один вузол, тому лише активний буде записувати дані в mongodb і надсилати команди клієнтам UDP.

Екземпляр драйвера може мати лише одне підключення. Якщо потрібно кілька підключень, необхідно запустити кілька екземплярів драйвера (кожен повинен прослуховувати окремий порт UDP, коли запускається на одному сервері).

Для кожного екземпляра в "protocolConnections" потрібно створити одне підключення:

    db.protocolConnections.insert ({
        "protocolDriver": "I104M",              // ім'я драйвера має бути "I104M"
        "protocolDriverInstanceNumber": 1,      // номер екземпляра, за потреби використовуйте 1 або більше
        "protocolConnectionNumber": 61,         // номер з'єднання (унікальний номер для збору)
        "name": "I104M-1",                      // назва з'єднання (документальне)
        "description": "I104M Connection",      // опис (документальний)
        "enabled": true,                        // увімкнути підключення
        "commandsEnabled": true,                // увімкнути команди для з'єднання (якщо значення false, команди не пересилатимуться)
        "ipAddressLocalBind": "0.0.0.0:8099",   // адреса прив'язки та порт для прослуховування повідомлень UPD
        "ipAddresses": ["127.0.0.1:8098"]       // тут приймаємо лише повідомлення з адрес, доставляємо команди на IP: порт
        })


Потрібно перезавантажити драйвер при зміні конфігурації у protocolDriverInstance або protocolConnections.

Щоб оновити теги за допомогою цього джерела даних, встановіть для тегу "protocolSourceConnectionNumber" та "protocolSourceObjectAddress".
"ProtocolSourceObjectAddress" повинен бути унікальним для того самого з'єднання.

    db.realtimeData.update ({
        "tag": "SOME-TAG"                           // тег, який буде оновлено
        }, {
        "$ set": {
            "protocolSourceConnectionNumber": 61,   // номер підключення, який оновить цей тег
            "protocolSourceObjectAddress": 1001     // адреса об'єкта на протоколі
        }
    })
    