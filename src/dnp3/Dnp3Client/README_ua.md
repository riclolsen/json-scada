# DNP3 Драйвер клієнтського протоколу

Цей драйвер реалізує клієнт для протоколу DNP3. За необхідності, він може мати кілька підключень до серверів DNP3 на декількох комп’ютерах.

Для конфігурації драйвера необхідно створити один або кілька екземплярів драйвера і принаймні для підключення на кожен екземпляр. Також теги, призначені для оновлення, повинні бути налаштовані належним чином.

## Налаштуйте екземпляр драйвера

Щоб створити новий екземпляр клієнта DNP3, вставте новий документ у колекцію _protocolDriverInsests_, використовуючи таку команду:

    use json_scada_db_name
    db.protocolDriverInstances.insert({
            protocolDriver: "DNP3",
            protocolDriverInstanceNumber: 1,
            enabled: true,
            logLevel: 1,
            nodeNames: ["mainNode"], 
            activeNodeName: "mainNode",
            activeNodeKeepAliveTimeTag: new Date(),
            keepProtocolRunningWhileInactive: false
        });


* _**protocolDriver**_ [String] - ім'я драйвера протоколу, має бути "DNP3".**Обов’язковий параметр**.
* _**protocolDriverInstanceNumber**_ [Double] - номер екземпляра. Використовуйте від 1 до N, щоб пронумерувати екземпляри. Для одного і того ж драйвера номери екземплярів повинні бути унікальними. Номер екземпляра дає змогу запустити використання кількох процесів драйвера, кожен з різною конфігурацією.**Обов’язковий параметр**.
* _**увімкнено**_ [логічне значення] - керує ввімкненням екземпляра. Використовуйте тут false, щоб вимкнути екземпляр.**Обов’язковий параметр**.
* _**logLevel**_ [Double] - код номера для рівня журналу (0 = мінімальний, 1 = основний, 2 = детальний, 3 = налагоджений). Занадто багато реєстрації (рівні 2 та 3) може вплинути на продуктивність.**Обов’язковий параметр**.
* _**nodeNames**_ [Array of Strings] - масив імен вузлів, які можуть запускати екземпляр. Використовуйте більше одного вузла для надмірності. Кожен надлишковий екземпляр, що працює на окремих вузлах, матиме однакові підключення та дані, увімкнені для сканування та оновлення.**Обов’язковий параметр**.
* _**activeNodeName**_ [Рядок] - ім'я драйвера протоколу, який активний на даний момент. Це оновлено драйверами для контролю надмірності.**Необов’язково**.
* _**activeNodeKeepAliveTimeTag**_ [Дата] - це регулярно оновлюється активним драйвером.**Необов’язково**.
* _**keepProtocolRunningWhileInactive**_ [логічне значення] - Визначте драйвер, який буде підтримувати протокол, а не основний активний драйвер. В даний час підтримується лише значення _false_.**Необов’язково**.

Зміни в конфігурації _protocolDriverInsests_ вимагають перезапуску процесів екземплярів драйвера, щоб бути ефективними.

## Налаштуйте підключення клієнта до серверів DNP3

У кожному екземплярі цього драйвера може бути визначено багато клієнтських підключень, які повинні бути описані в колекції _protocolConnections_ .

    use json_scada_db_name
    db.protocolConnections.insert({
        protocolDriver: "DNP3",
        protocolDriverInstanceNumber: 1,
        protocolConnectionNumber: 64,
        name: "KIK1",
        description: "KIK1 Station DNP3",
        enabled: true,
        commandsEnabled: true,
        ipAddressLocalBind: "", 
        ipAddresses: ["192.168.0.31:20000"],
        portName: "COM3", 
        baudRate: 9600,
        parity: "Even",
        stopBits: "One",
        handshake: "None",
        asyncOpenDelay: 0,
        localLinkAddress: 1,
        remoteLinkAddress: 2,
        giInterval: 300,
        class0ScanInterval: 30,
        class1ScanInterval: 30,
        class2ScanInterval: 30,
        class3ScanInterval: 30,        
        timeSyncMode: 2,
        enableUnsolicited: true,
        rangeScans: [ 
            {
                group: 1,
                variation: 1,
                startAddress: 10,
                stopAddress: 15,
                period: 120
            },
            {
                group: 2,
                variation: 1,
                startAddress: 0,
                stopAddress: 50,
                period: 150
            },
        ],
        stats: null
    });

* _**protocolDriver**_ [String] - ім'я драйвера протоколу, має бути "DNP3".**Обов’язковий параметр**.
* _**protocolDriverInstanceNumber**_ [Double] - номер екземпляра. Використовуйте від 1 до N, щоб пронумерувати екземпляри. Для одного і того ж драйвера номери екземплярів повинні бути унікальними. Номер екземпляра дозволяє запустити використання кількох процесів драйвера, кожен з різною конфігурацією.**Обов’язковий параметр**.
* _**protocolConnectionNumber**_ [Double] - Номерний номер для підключення протоколу. Це повинно бути унікальним для всіх підключень усіх драйверів системи. Цей номер використовується для визначення з'єднання, яке може оновити тег.**Обов’язковий параметр**.
* _**name**_ [String] - Ім'я для з'єднання. Використовуватиметься для лісозаготівлі.**Обов’язковий параметр**.
* _**descryption**_ [String] - Опис з метою підключення. Просто документально.**Необов’язковий параметр**.
* _**commandsEnabled**_ [Boolean] - керує ввімкненням з'єднання. Використовуйте тут false, щоб вимкнути з’єднання.**Обов’язковий параметр**.
* _**commandEnabled**_ [Boolean] - Дозволяє вимкнути команди (повідомлення в напрямку управління) для з'єднання. Використовуйте тут false, щоб вимкнути команди.**Обов’язковий параметр**.
* _**localLinkAddress**_ [Double] - Місцева адреса посилання для з'єднання (адреса ініціатора).**Обов’язковий параметр**.
* _**remoteLinkAddress**_ [Double] - Адреса віддаленого посилання сервера (адреса ініціатора).**Необов’язковий параметр**.
* _**giInterval**_ [Double] - період опитування загальної станції в секундах.**Необов’язковий параметр**.
* _**timeSyncMode**_ [Double] - Режим синхронізації часу (з клієнта на запит сервера RTU): 0 = немає, 1 = не-мережа, 2 = мережа. Використовуйте нуль, щоб вимкнути.**Обов’язковий параметр**.
* _**stats**_ [Object] - статистика протоколу, оновлена ​​драйвером.**Обов’язковий параметр**.

Для зв'язку TCP.
* _**ipAddressLocalBind**_ [Strings] - Не використовується для параметра TCP (залиште порожнім).**Необов’язковий параметр**.
* _**ipAddresses**_ [Array of Strings] - масив IP-адрес та портів для DNP3-серверів, які слід перевірити (наразі підтримується лише перший сервер).**Обов’язковий параметр**.

Для зв'язку UDP.
* _**ipAddressLocalBind**_ [Strings] - IP-адреса та порт локальної кінцевої точки UCP.**Обов’язковий параметр**.
* _**ipAddresses**_ [Array of Strings] - масив IP-адрес та портів для DNP3-серверів, які слід перевірити (наразі підтримується лише перший сервер).**Обов’язковий параметр**.

Для послідовного зв'язку.
* _**portName**_ [String] - назва порту Comm, наприклад "COM1", "/ dev / ttyS0", "192.168.0.1:2410" для TCP-адреси: порт.**Обов’язковий параметр**.
* _**baudRate**_ [Double] - швидкість передачі даних в порт кому.**Обов’язковий параметр**.
* _**parity**_ [Strings] - парність портів зв'язку Немає | Четне | Непарне.**Обов’язковий параметр**.
* _**stopBits**_ [String] - номер порту зв'язку стоп-бітів None|Xon|Rts.**Обов’язковий параметр**.
* _**handshake**_ [String] - параметр рукостискання порту зв'язку None|Xon|Rts.**Обов’язковий параметр**.
* _**asyncOpenDelay**_ [Double] - Затримка першого TX в мс.**Обов’язковий параметр**.

Для TLS через TCP.
* _**ipAddressLocalBind**_ [String] - Не використовується для параметра TLS (залиште порожнім).**Необов’язковий параметр**.
* _**ipAddresses**_ [Array of Strings] - масив IP-адрес та портів для DNP3-серверів, які слід перевірити (наразі підтримується лише перший сервер).**Обов’язковий параметр**.
* _**allowTLSv10**_ [Boolean] - Дозволити TLS версії 1.0 (за замовчуванням false).
* _**allowTLSv11**_ [Boolean] - Дозволити TLS версії 1.1 (за замовчуванням false).
* _**allowTLSv12**_ [Boolean] - Дозволити TLS версії 1.2 (за замовчуванням true).
* _**allowTLSv13**_ [Boolean] - Дозволити TLS версії 1.3 (за замовчуванням true).
* _**cipherList**_ [String] - Відкриває список шифрів у форматі.
* _**localCertFilePath**_ [String] - файл, що містить сертифікат (або ланцюжок сертифікатів), який буде представлений на віддаленій стороні з'єднання.
* _**peerCertFilePath**_ [String] - Файл сертифіката, що використовується для перевірки рівня або сервера.
* _**privateKeyFilePath**_ [String] - файл, що містить закритий ключ, що відповідає локальному сертифікату.

### Кілька крапель

У випадку декількох випадків кілька підпорядкованих пристроїв мають спільне з'єднання TCP, UDP, TLS або послідовний канал.

Для конфігурації з декількома краплями використовуйте нове з'єднання (у колекції _protocolConnections_) для кожного пристрою, що повторює специфікацію каналу (IP-адреса кінцевої точки або послідовний порт). Кожен пристрій спільного каналу повинен мати окремий параметр _remoteLinkAddress_.

## Налаштуйте теги для оновлення

Кожен тег, який потрібно оновити під час з’єднання, повинен мати налаштований джерело протоколу.
Оновити тег може лише одне джерело.

Виберіть тег для оновлення підключення, як показано нижче.

    використовуйте json_scada_db_name
    db.realtimeData.updateOne ({"tag": "A_TAG_NAME"}, {
        $ set: {
            protocolSourceConnectionNumber: 64,
            protocolSourceCommonAddress: 1,
            protocolSourceObjectAddress: 0,
            protocolSourceASDU: 0,
            protocolSourceCommandDuration: 0,
            protocolSourceCommandUseSBO: false,
            kconv1: 1,
            kconv2: 0
            }
    });

* _**protocolConnectionNumber**_ [Double] - Номерний номер для підключення протоколу. Тільки це з'єднання протоколу може оновити тег.**Обов’язковий параметр**.
* _**protocolSourceCommonAddress**_ [Double] - код групи DNP3 (див. нижче).**Обов’язковий параметр**.
* _**protocolSourceObjectAddress**_ [Double] - адреса об’єкта. Ця адреса в поєднанні з _protocolSourceCommonAddress_ повинна бути унікальною для з'єднання.**Обов’язковий параметр**.
* _**protocolSourceASDU**_ [Double] - Для команд використовується цей варіант. Для контрольованих точок цей параметр ігнорується.**Обов’язковий параметр**.
* _**protocolSourceCommandDuration**_ [Double] - Параметри команди. Просто значущий для команд.**Обов’язковий параметр**.
* _**protocolSourceCommandUseSBO**_ [Double] - Використовуйте послідовність керування Select-Before-Operate. Просто значущий для команд.**Обов’язковий параметр**.
* _**kconv1**_ [Double] - Аналоговий коефіцієнт перетворення: множник. Використовуйте -1 для інвертування цифрових значень.**Обов’язковий параметр**.
* _**kconv2**_ [Double] - Аналоговий коефіцієнт перетворення: суматор.**Обов’язковий параметр**.

## Підтримувана група DNP3 / Варіації та коди для загального параметра адреси

Група об'єктів | Варіації | Загальна адреса | Опис
------------- | ------------------- | ---------------- | ---------------------------
1 | 0,1,2 |**1**| Двійковий вхід
2 | 0,1,2,3 |**1**| Зміна двійкового входу
3 | 0,1,2 |**3**| Подвійний двійковий вхід
4 | 0,1,2,3 |**3**| Зміна подвійного двійкового входу
30 | 0,1,2,3,4,5,6 |**30**| Аналоговий вхід
31 | 0,1,2,3,4,5,6,7,8 |**30**| Зміна аналогового входу
20 | 0,1,2,5,6 |**20**| Лічильник
22 | 0,1,2,5,6 |**20**| Зміна лічильника
21 | 0,1,2,5,6,9,10 |**21**| Заморожена стійка
23 | 0,1,2,5,6 |**21**| Заморожена лічильник події
10 | 0,1,2 |**10**| Двійковий вихід
11 | 0,1,2 |**10**| Подія двійкового виходу
12 | 0,1 |**12**| CROB (команди)
40 | 0,1,2,3,4 |**40**| Стан аналогового виходу
42 | 0,1,2,3,4 |**40**| Подія аналогового виходу
41 | 0,1,2,3,4 |**41**| Блок аналогового виводу (команди)
43 | 1,2 |**43**| Подія аналогових команд
13 | 1,2 |**13**| Подія двійкових команд
110 | 0 |**110**| Рядок октету
111 | 0 |**110**| Рядок октетів
50 | 1,3,4 |**50**| Час та інтервал

У поле _protocolSourceCommonAddress_ введіть відповідне значення зі стовпця _Загальна адреса_.
Для команд також налаштуйте варіацію на _protocolSourceASDU_.

Для команд CROB використовуйте _protocolSourceCommandDuration_, щоб встановити деталі команд:

Тип операції | protocolSourceCommandDuration
-----------------------| ------------------------------
НЕ ВКАЗАНО/НУЛ | 0
ІМПУЛЬС 1=УВІМК. 0=ВИМК. | 1
ІМПУЛЬС 0=УВІМК. 1=ВИМК. | 2
ЗАМЕЧКА 1=УВІМК. 0=ВИМК. | 3
ЗАМІЧКА 0=УВІМК. 1=ВИМК. | 3
PULSE + CLOSE=1/TRIP=0 | 11
ЗАМЕЧКА + ЗАКРИТИ=1/ПУСК=0 | 13
PULSE + CLOSE=0/TRIP=1 | 21
ЗАМЕЧКА + ЗАКРИТИ=0/ПУСК=1 | 23

## Обробити аргументи командного рядка

Цей драйвер має такі аргументи командного рядка.

* _**1-й арг. - Номер екземпляра**_ [Integer] - Номер екземпляра, який потрібно виконати.**Необов’язковий аргумент, за замовчуванням = 1**.
* _**2-й арг. - Журнал. Рівень**_ [Integer] - Рівень журналу (0=minimum,1=basic,2=detailed,3=debug).**Необов’язковий аргумент, за замовчуванням = 1**.
* _**3-й арг. - Шлях / ім'я конфігураційного файлу**_ [String] - Повний шлях/ім'я конфігураційного файлу JSON-SCADA.**Необов’язковий аргумент, за замовчуванням="../ conf/json-scada.json"**.